#include<console.pi>

#define $instpair(_fst,_snd) \
  rec $instpair; \
  2->1 \
  {^fst: \
    1->2: _fst; \
    $instpair; \
   ^snd: \
    1->2: _snd; \
    $instpair; \
   ^end: \
    $end; \
  }
#define $pair \
  2: #fst; \
  2: #snd; \
  2->1: #fst; \
  2->1: #snd; \
  $instpair(#fst,#snd)

global $pair pair(1 pure,2);
local pure service Pair(pair (1 of 2) s)
( s >> #a;
  s >> #b;
  s[2] >> fst;
  s[2] >> snd;
  local pure InstPair(#a a, #b b, $instpair(#a,#b)(1 of 1 pure, 2) this)
  ( this[2]>>
    {^fst:
      this[2]<<a;
      InstPair(a,b,this);
     ^snd:
      this[2]<<b;
      InstPair(a,b,this);
     ^end:
    }
  )
  InstPair(fst,snd,s);
)
|
c=new console(2 of 2);
p1 = new pair(2 of 2);
p1 << String;
p1 << Int;
p1[1] << "Hello World";
p1[1] << 5;
p1[1] << ^fst;
p1[1] >> x;
c[1] << ^PutInt << x;
p1[1] << ^snd;
p1[1] >> y;
c[1] << ^PutString << y;
p1[1] << ^end;
c[1]<<^Stop;
